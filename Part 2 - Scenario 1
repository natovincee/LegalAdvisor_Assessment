import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.openqa.selenium.support.ui.ExpectedConditions;
import java.time.Duration;
import java.util.List;

public class CheckoutFlowTest {

    public static void main(String[] args) {

        WebDriver driver = new ChromeDriver();
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));

        try {
            // 1. Open site & login
            driver.get("https://www.saucedemo.com/");
            driver.manage().window().maximize();

            driver.findElement(By.id("user-name")).sendKeys("standard_user");
            driver.findElement(By.id("password")).sendKeys("secret_sauce");
            driver.findElement(By.id("login-button")).click();

            // 2. Add any 2 items
            driver.findElement(By.id("add-to-cart-sauce-labs-backpack")).click();
            driver.findElement(By.id("add-to-cart-sauce-labs-bike-light")).click();

            // 3. Verify cart count = 2
            WebElement cartBadge = driver.findElement(By.className("shopping_cart_badge"));
            assert cartBadge.getText().equals("2") : "Cart count mismatch";

            // 4. Go to cart
            driver.findElement(By.className("shopping_cart_link")).click();

            // 5. Verify item prices
            List<WebElement> prices = driver.findElements(By.className("inventory_item_price"));
            double totalPrice = 0.0;
            for (WebElement price : prices) {
                totalPrice += Double.parseDouble(price.getText().replace("$", ""));
            }

            // 6. Start checkout
            driver.findElement(By.id("checkout")).click();

            // 7. Try continue with missing field
            driver.findElement(By.id("continue")).click();

            WebElement errorMsg = wait.until(
                ExpectedConditions.visibilityOfElementLocated(By.cssSelector("h3[data-test='error']"))
            );
            assert errorMsg.isDisplayed() : "Error message not shown";

            // 8. Fill all required fields
            driver.findElement(By.id("first-name")).sendKeys("Vince");
            driver.findElement(By.id("last-name")).sendKeys("Tester");
            driver.findElement(By.id("postal-code")).sendKeys("1234");
            driver.findElement(By.id("continue")).click();

            // 9. Verify item total
            WebElement itemTotal = driver.findElement(By.className("summary_subtotal_label"));
            double displayedItemTotal = Double.parseDouble(
                    itemTotal.getText().replace("Item total: $", "")
            );
            assert displayedItemTotal == totalPrice : "Item total mismatch";

            // 10. Verify tax and final total
            double tax = Double.parseDouble(
                    driver.findElement(By.className("summary_tax_label"))
                          .getText().replace("Tax: $", "")
            );

            double finalTotal = Double.parseDouble(
                    driver.findElement(By.className("summary_total_label"))
                          .getText().replace("Total: $", "")
            );

            assert finalTotal == displayedItemTotal + tax : "Final total mismatch";

            // 11. Finish order
            driver.findElement(By.id("finish")).click();

            WebElement successMsg = wait.until(
                ExpectedConditions.visibilityOfElementLocated(By.className("complete-header"))
            );
            assert successMsg.getText().equals("Thank you for your order!");

            // 12. Logout
            driver.findElement(By.id("react-burger-menu-btn")).click();
            wait.until(ExpectedConditions.elementToBeClickable(By.id("logout_sidebar_link"))).click();

            System.out.println("TEST PASSED âœ…");

        } finally {
            driver.quit();
        }
    }
}
